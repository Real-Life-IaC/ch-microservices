# üèÉ Running migrations

We use [Alembic](https://pypi.org/project/alembic/) to run database migrations. A few things to note before we start:

1. We run migrations manually in our AWS environments. They don't run on CI/CD.
    1. We want to limit tha blast radius if a migration goes wrong, running the `upgrade`/`dowgrade` commands manually allow us to easily revert changes.
    2. Running migrations manually also allow for easier debuging and logs inspection.
2. We use the alembic `autogenerate` flag when creating migrations to avoid drift between the DB and the models.
    1. We ensure that changes are applied to models, so that `autogenerate` can pick them up.
3. Ensure your `downgrade` command works!
    1. Our unit tests run the upgrade and downgrade commands to set up the DB for each test. If the downgrade is misconfigured, then the tests will fail.
3. Always execute the upgrades in lower environments (development/staging) before running them in production.
    1. Deploy the API after running the upgrade and ensure everything works as expected.

## üê¶ Creating a new revision with Alembic

Here are the steps you need to follow to create a new migration:

1. Alter your models as needed.
2. Run `make up` to run the application (with Postgres) on Docker.
2. Run `make alembic-revision MESSAGE="short migration message"`.
    1. The migration message should be a short description of what the migration does.
    1. The Linear ticket number is mandatory.
    1. Check the newly created migration file and add/edit your revision as needed.

### Notes about the revision generation:

* Revisions are generated against the local Docker database.
    * Never apply changes directly to the AWS DBs, this will cause drift and they will be out of sync with the local version.
* Stick as much as possible with the autogenerated revisions to avoid drift between DB and models.

## üíÄ Running Alembic upgrades in AWS (development/staging/production)

You already have the migration file and you tested the changes in the local Docker Database! Now all you have to do is to apply the same changes to the databases in AWS. Please be extra careful when running migrations in production.

1. Connect to the VPN (Alembic needs to connect to the actual database in AWS)
2. Run `aws sso login` to authenticate with AWS
3. Run `make alembic-upgrade AWS_PROFILE=<name-of-your-profile>`.
    1. The `AWS_PROFILE` is the AWS profile you want to use to connect to the database.
    2. You can find the profile name in `~/.aws/config`.
    3. The profile must have access to the `/api/storage/cluster/credentials` secret in AWS Secrets Manager.
4. Test the API to make sure everything works as expected.


**To downgrade a migration, run `make alembic-downgrade AWS_PROFILE=<name-of-your-profile>`.**
